/*! LineUpJS - v0.1.0 - 2016-04-13
* https://github.com/Caleydo/lineup.js
* Copyright (c) 2016 ; Licensed BSD */
(function(){function a(a,b,c){var d;!function(a,b,c,d){function e(d,e,f){var g,h;return this.storage=d.storage,this.spec=d,this.$container=e,this.tooltip=a.createTooltip(e.node()),this.tooltip.hide(),this.listeners=b.dispatch("hover","change-sortcriteria","change-filter","columns-changed","selected","multiselected","generate-histogram"),this.config=c.extend(!0,{},a.defaultConfig,f,{columnBundles:{primary:{sortedColumn:null,sortingOrderAsc:!0,prevRowScale:null}}}),this.storage.config=this.config,this.config.svgLayout.addPlusSigns||(this.config.svgLayout.plusSigns={}),"combined"===this.config.svgLayout.mode?(e.classed("lu-mode-combined",!0),this.$table=e.append("svg").attr("class","lu"),g=this.$table.append("defs"),g.append("defs").attr("class","columnheader"),g.append("defs").attr("class","column"),g.append("defs").attr("class","overlay"),this.$body=this.$table.append("g").attr("class","body").attr("transform","translate(0,"+this.config.htmlLayout.headerHeight+")"),this.$header=this.$table.append("g").attr("class","header"),this.$bodySVG=this.$headerSVG=this.$table,h=this.initScrolling(c(e.node()),this.config.htmlLayout.headerHeight)):(e.classed("lu-mode-separate",!0),this.$table=e,this.$headerSVG=this.$table.append("svg").attr("class","lu lu-header"),this.$headerSVG.attr("height",this.config.htmlLayout.headerHeight),this.$headerSVG.append("defs").attr("class","columnheader"),this.$header=this.$headerSVG.append("g"),this.$bodySVG=this.$table.append("div").attr("class","lu-wrapper").append("svg").attr("class","lu lu-body"),g=this.$bodySVG.append("defs"),g.append("defs").attr("class","column"),g.append("defs").attr("class","overlay"),this.$body=this.$bodySVG,h=this.initScrolling(c(e.node()).find("div.lu-wrapper"),0)),this.selectVisible=h.selectVisible,this.onScroll=h.onScroll,this.$header.append("rect").attr({width:"100%",height:this.config.htmlLayout.headerHeight,fill:"lightgray"}),this.$header.append("g").attr("class","main"),this.$header.append("g").attr("class","overlay"),this.headerUpdateRequired=!0,this.stackedColumnModified=null,this.dragWeight=this.initDragging(),this}a.prototype=e.prototype=c.extend(e.prototype,a.prototype),a.create=function(a,b,c){"storage"in a||(a={storage:a});var d=new e(a,b,c);return d.startVis(),d},a.prototype.scrolled=function(a,b){"combined"===this.config.svgLayout.mode?this.$header.attr("transform","translate(0,"+a+")"):this.$header.attr("transform","translate("+-b+",0)")},a.defaultConfig={colorMapping:b.map(),columnColors:b.scale.category20(),grayColor:"#999999",numberformat:b.format(".3n"),htmlLayout:{headerHeight:50,headerOffset:2,buttonTopPadding:10,labelLeftPadding:12,buttonRightPadding:15,buttonWidth:13},renderingOptions:{stacked:!1,values:!1,animation:!0,histograms:!1},svgLayout:{mode:"combined",rowHeight:20,rowPadding:.2,rowBarPadding:2,backupScrollRows:4,animationDuration:1e3,addPlusSigns:!1,plusSigns:{addStackedColumn:{title:"Add stacked column",action:"addNewEmptyStackedColumn",x:0,y:2,w:21,h:21}},rowActions:[]},manipulative:!0,interaction:{tooltips:!0,multiselect:function(){return!1},rangeselect:function(){return!1}},filter:{skip:0,limit:Number.POSITIVE_INFINITY,filter:d}},a.prototype.on=function(a,b){return arguments.length<2?this.listeners.on(a):(this.listeners.on(a,b),this)},a.prototype.changeDataStorage=function(a){this.storage=a.storage,this.storage.config=this.config,this.spec=a,this.config.columnBundles.primary.sortedColumn=null,this.headerUpdateRequired=!0,delete this.prevRowScale,this.startVis()},a.prototype.changeInteractionOption=function(a,b){var c=this.config.interaction[a];c!==b&&(this.config.interaction[a]=b)},a.prototype.changeRenderingOption=function(a,b){var c=this.config.renderingOptions[a];c!==b&&(this.config.renderingOptions[a]=b,"histograms"===a&&b&&this.storage.resortData({filteredChanged:!0}),this.updateAll(!0))},a.prototype.startVis=function(){this.assignColors(this.storage.getRawColumns()),this.headerUpdateRequired=!0,this.storage.resortData({}),this.updateAll()},a.prototype.assignColors=function(c){var d=this.config;d.colorMapping=b.map();var e=0;c.forEach(function(b){b.color?d.colorMapping.set(b.id,b.color):b instanceof a.LineUpStringColumn||"rank"===b.id?d.colorMapping.set(b.id,d.grayColor):(d.colorMapping.set(b.id,d.columnColors(e)),e++)})},a.prototype.updateAll=function(a,b){function c(b){var c=d.storage.getColumnLayout(b);d.updateHeader(c),d.updateBody(c,d.storage.getData(b),a||!1)}var d=this;b?c(b):Object.keys(this.storage.bundles).forEach(c)},a.prototype.sortBy=function(a,b){a=a||this.storage.primaryKey,b=b||!1;var c=this.storage.getColumnByName(a);if(!c)return!1;var d=this.config.columnBundles[c.columnBundle];d.sortingOrderAsc=b,d.sortedColumn=c,this.listeners["change-sortcriteria"](this,c,d.sortingOrderAsc),this.config.sorting&&this.config.sorting.external||this.storage.resortData({column:c,asc:d.sortingOrderAsc}),this.updateAll(!1,c.columnBundle)},a.prototype.toggleStackedRendering=function(){this.config.renderingOptions.stacked=!this.config.renderingOptions.stacked,this.updateAll(!0)},a.prototype.toggleValueRendering=function(){this.config.renderingOptions.values=!this.config.renderingOptions.values,this.updateAll(!0)},a.prototype.setLimits=function(a,b){this.config.filter.skip=a,this.config.filter.limit=b,this.storage.resortData({}),this.updateAll()},a.prototype.changeWeights=function(b,c){"string"==typeof b&&(b=this.storage.getColumnByName(b)),b=b||this.config.columnBundles.primary.sortedColumn;var d=b.columnBundle;return b instanceof a.LayoutStackedColumn?(b.updateWeights(c),b===this.config.columnBundles[d].sortedColumn&&(this.listeners["change-sortcriteria"](this,b,this.config.columnBundles[d]),this.config.sorting&&this.config.sorting.external||this.storage.resortData({key:d})),this.updateAll(!1,d),!0):!1},a.prototype.changeFilter=function(a,b){"string"==typeof a&&(a=this.storage.getColumnByName(a)),a.filter=b,this.listeners["change-filter"](this,a),this.config.filtering&&this.config.filtering.external||this.storage.resortData({filteredChanged:!0}),this.updateBody()},a.prototype.destroy=function(){this.tooltip.destroy(),this.$container.selectAll("*").remove(),"combined"===this.config.svgLayout.mode&&this.$container.off("scroll",this.onScroll)}}(d||(d={}),b,a);var d;!function(a,b,c,d,e){function f(a){return a.replace(/[\s!\'#$%&'\(\)\*\+,\.\/:;<=>\?\@\[\\\]\^`\{\|\}~]/g,"_")}function g(a){this.column=a.column,this.label=a.label||a.column,this.color=a.color,this.id=f(a.id||this.column),this.missingValue=a.missingValue,this.layout={}}function h(a){return"number"!=typeof a||isNaN(a)}function i(a,c,d){g.call(this,a),this.domain=a.domain||[NaN,NaN],this.range=a.range||[0,1],"undefined"==typeof this.missingValue&&(this.missingValue=NaN);var e=this;if(h(this.domain[0])||h(this.domain[1])){var f=b.extent(d,function(a){return e.getValue(a)});h(this.domain[0])&&(this.domain[0]=f[0]),h(this.domain[1])&&(this.domain[1]=f[1])}}function j(a){g.call(this,a)}function k(a,c,d){g.call(this,a),this.categories=[],this.categoryColors=b.scale.category10().range();var e=this;a.categories&&a.categories.forEach(function(a,b){"string"==typeof a?e.categories.push(a):(e.categories.push(a.name),e.categoryColors[b]=a.color)}),0===this.categories.length&&(this.categories=b.set(d.map(function(a){return e.getValue(a)})).values(),this.categories.sort())}function l(a){var b=this;this.columnWidth=a.width||100,this.id=d.uniqueId("Column_"),this.filter=a.filter,this.parent=a.parent||null,this.columnBundle="primary",this.sortBy=function(a,c){return a=b.getValue(a),c=b.getValue(c),b.safeSortBy(a,c)}}function m(a,b){l.call(this,a),this.columnLink=a.column,this.column=b.get(a.column),this.id=f(d.uniqueId(this.columnLink+"_"))}function n(a,c){m.call(this,a,c),this.value2pixel=b.scale.linear().domain([0,1]).range([0,this.columnWidth]);var d=a.domain||this.column.domain;h(d[0])&&(d[0]=this.column.domain[0]),h(d[1])&&(d[1]=this.column.domain[1]),this.scale=b.scale.linear().clamp(!0).domain(d).range(a.range||this.column.range),this.histgenerator=b.layout.histogram();var e=this;this.histgenerator.range(this.scale.range()),this.histgenerator.value(function(a){return e.getValue(a)}),this._hist=[]}function o(a,b){m.call(this,a,b)}function p(a,b){m.call(this,a,b)}function q(a,b){m.call(this,a,b)}function r(a,c,e,g){l.call(this,a?a:{},[]),this.columnWidth=a?a.width||50:50,this.id=f(d.uniqueId("rank_")),this.values=b.map(),this.storage=g}function s(a,b){l.call(this,a,b),this.childrenLinks=a.children||[],this.label=a.label||this.id}function t(a,c,d){s.call(this,a,c),this.childrenWeights=[],this.childrenWidths=[],this.toLayoutColumn=d,this.children=[],this.emptyColumns=[],this.scale=b.scale.linear().domain([0,1]).range([0,this.columnWidth]),this.init(a);var e=this;this.sortBy=function(a,b){var c=0,d=0;return e.children.forEach(function(e){c+=e.getWidth(a),d+=e.getWidth(b)}),e.safeSortBy(c,d)}}function u(a){l.call(this,a,[]),this.id=d.uniqueId("empty_"),this.label="{empty}",this.columnWidth=50}function v(a){a=a||{},l.call(this,a,[]),this.id=d.uniqueId("action_"),this.label="",this.columnWidth=a.width||50}a.LineUpColumn=g,g.prototype=c.extend({},{},{getValue:function(a){var b=a[this.column];return"undefined"==typeof b?this.missingValue:b},getRawValue:function(a){var b=this.getValue(a);return"undefined"==typeof b?"":b}}),a.LineUpNumberColumn=i,i.prototype=c.extend({},g.prototype,{getValue:function(a){var b=g.prototype.getValue.call(this,a);return(null===b||"undefined"==typeof b||""===b||0===b.toString().trim().length)&&(b=this.missingValue),+b},getRawValue:function(a){var b=g.prototype.getValue.call(this,a);return isNaN(b)?"":b}}),a.LineUpStringColumn=j,j.prototype=c.extend({},g.prototype,{}),a.LineUpCategoricalColumn=k,k.prototype=c.extend({},g.prototype,{}),a.LayoutColumn=l,l.prototype=c.extend({},{},{setColumnWidth:function(a,b){this.columnWidth=a,!b&&this.parent&&this.parent.updateWidthFromChild({id:this.id,newWidth:a})},getColumnWidth:function(){return this.columnWidth},prepare:function(){},safeSortBy:function(a,c){var d="number"==typeof a&&isNaN(a),e="number"==typeof c&&isNaN(c);return d&&e?0:d?1:e?-1:b.descending(a,c)},flattenMe:function(a){a.push(this)},description:function(){var a={};return a.width=this.columnWidth,a.filter=this.filter,a},makeCopy:function(){return new l(this.description())},isFiltered:function(){return"undefined"!=typeof this.filter},filterBy:function(){return!0}}),a.LayoutSingleColumn=m,m.prototype=c.extend({},l.prototype,{getValue:function(a,b){return"raw"===b?this.column.getRawValue(a):this.column.getValue(a)},getLabel:function(){return this.column.label},getDataID:function(){return this.column.id},description:function(){var a=l.prototype.description.call(this);return a.column=this.columnLink,a},makeCopy:function(){var a=this.description(),c=b.map();c.set(this.columnLink,this.column);var d=new m(a,c);return d}}),a.LayoutNumberColumn=n,n.prototype=c.extend({},m.prototype,{mapping:function(a){return arguments.length<1?this.scale:(this.scale=a.clamp(!0),void this.histgenerator.range(a.range()))},originalMapping:function(){return b.scale.linear().clamp(!0).domain(this.column.domain).range(this.column.range)},getHist:function(a){var b=this;this.histogramGetter?this.histogramGetter(this,function(c){a.call(b,c)}):setTimeout(function(){a.call(b,b._hist)},0)},prepare:function(a,c,d){if(this.histogramGetter=d,!c||d)return void(this._hist=[]);this._hist=this.histgenerator(a).map(function(a){return{x:a.x,dx:a.dx,y:a.y}});var e=b.max(this._hist,function(a){return a.y});this._hist.forEach(function(a){e>0?a.y/=e:a.y=0})},binOf:function(a,b){var c=this;this.getHist(function(d){var e,f=c.getValue(a);if(d)for(e=d.length-1;e>=0;--e){var g=d[e];if(g.x<=f&&f<=g.x+g.dx)return void b.call(c,e)}b.call(c,-1)})},setColumnWidth:function(a,b){this.value2pixel.range([0,a]),m.prototype.setColumnWidth.call(this,a,b)},getValue:function(a,b){return"raw"===b?this.column.getRawValue(a):this.scale(this.column.getValue(a))},getWidth:function(a){var b=this.getValue(a);return isNaN(b)||"undefined"==typeof b?0:this.value2pixel(b)},filterBy:function(a){var b=this.filter;if("undefined"==typeof b||!this.column)return!0;var c=this.getValue(a,"raw");return"number"==typeof b&&isNaN(b)?!isNaN(c):"number"==typeof b?c>=b:Array.isArray(b)?b[0]<=c&&c<=b[1]:!0},description:function(){var a=l.prototype.description.call(this);a.column=this.columnLink,a.type="number";var b=this.scale.domain(),c=this.column.domain;return(b[0]!==c[0]||b[1]!==c[1])&&(a.domain=b),b=this.scale.range(),c=this.column.range,(b[0]!==c[0]||b[1]!==c[1])&&(a.range=b),a},makeCopy:function(){var a=b.map();a.set(this.columnLink,this.column);var c=new n(this.description(),a);return c}}),a.LayoutStringColumn=o,o.prototype=c.extend({},m.prototype,{filterBy:function(a){var b=this.filter;if("undefined"==typeof b||!this.column)return!0;var c=this.getValue(a);return"boolean"==typeof c?c&&c.trim().length>0:"string"==typeof b&&b.length>0?c&&c.toLowerCase().indexOf(b.toLowerCase())>=0:b instanceof RegExp?c&&c.match(b):!0},makeCopy:function(){var a=b.map();a.set(this.columnLink,this.column);var c=new o(this.description(),a);return c}}),a.LayoutCategoricalColumn=p,p.prototype=c.extend({},m.prototype,{filterBy:function(a){var b=this.filter;if("undefined"==typeof b||!this.column)return!0;var c=this.getValue(a);return Array.isArray(b)&&b.length>0?b.indexOf(c)>=0:"string"==typeof b&&b.length>0?c&&c.toLowerCase().indexOf(b.toLowerCase())>=0:b instanceof RegExp?c&&c.match(b):!0},makeCopy:function(){var a=b.map();a.set(this.columnLink,this.column);var c=new p(this.description(),a);return c}}),a.LayoutCategoricalColorColumn=q,q.prototype=c.extend({},m.prototype,{getColor:function(a){var b=this.getValue(a,"raw");if(null===b||""===b)return null;var c=this.column.categories.indexOf(b);return 0>c?null:this.column.categoryColors[c]},filterBy:function(a){return p.prototype.filterBy.call(this,a)},makeCopy:function(){var a=b.map();a.set(this.columnLink,this.column);var c=new q(this.description(),a);return c}}),a.LayoutRankColumn=r,r.prototype=c.extend({},l.prototype,{setValue:function(a,b){this.values.set(a[this.storage.primaryKey],b)},getValue:function(a){return this.values.get(a[this.storage.primaryKey])},filter:function(a){var b=this.getValue(a);return"undefined"==typeof b?!0:"number"==typeof this.filter?b>=this.filter:Array.isArray(this.filter)?this.filter[0]<=b&&b<=this.filter[1]:!0},getLabel:function(){return"Rank"},getDataID:function(){return this.id},description:function(){var a=l.prototype.description.call(this);return a.type="rank",a},makeCopy:function(){var a=this.description(),b=new r(a,null,null,this.column.storage);return b}}),a.LayoutCompositeColumn=s,s.prototype=c.extend({},l.prototype,{getDataID:function(){return this.id},getLabel:function(){return this.label}}),a.LayoutStackedColumn=t,t.prototype=c.extend({},s.prototype,{getValue:function(a){var b=this,c=0;return this.children.forEach(function(d,e){var f=d.getValue(a);(isNaN(f)||"undefined"==typeof f)&&(f=0),c+=f*b.childrenWeights[e]}),c},init:function(a){var c=this;this.childrenLinks.length<1?this.emptyColumns.push(new u({parent:c})):(this.childrenLinks[0].hasOwnProperty("weight")?(this.childrenWeights=this.childrenLinks.map(function(a){return+(a.weight||1)}),this.scale.domain([0,b.sum(this.childrenWeights)]),a.hasOwnProperty("width")?this.childrenWidths=this.childrenWeights.map(function(a){return c.scale(a)}):(this.columnWidth=100*this.children.length,this.scale.range([0,c.columnWidth]))):(this.childrenWidths=this.childrenLinks.map(function(a){return+(a.width||100)}),this.childrenWeights=this.childrenWidths.map(function(a){return a/100}),this.columnWidth=b.sum(this.childrenWidths),this.scale.domain([0,b.sum(this.childrenWeights)]).range([0,this.columnWidth])),this.children=this.childrenLinks.map(function(a,b){return a.width=c.childrenWidths[b],a.parent=c,c.toLayoutColumn(a)}))},flattenMe:function(a,b){var c=!1;b&&(c=b.addEmptyColumns||!1),a.push(this),this.children.forEach(function(b){b.flattenMe(a)}),c&&this.emptyColumns.forEach(function(b){return b.flattenMe(a)})},filterBy:function(a){if("undefined"==typeof this.filter)return!0;var b=this.getValue(a);return"number"==typeof this.filter?b<=this.filter:Array.isArray(this.filter)?this.filter[0]<=b&&b<=this.filter[1]:!0},updateWidthFromChild:function(){var a=this;this.childrenWidths=this.children.map(function(a){return a.getColumnWidth()}),this.childrenWeights=this.childrenWidths.map(function(b){return a.scale.invert(b)}),this.columnWidth=b.sum(this.childrenWidths),this.scale.range([0,this.columnWidth]),this.scale.domain([0,b.sum(this.childrenWeights)])},setColumnWidth:function(a){var b=this;this.columnWidth=a,b.scale.range([0,this.columnWidth]),this.childrenWidths=this.childrenWeights.map(function(a){return b.scale(a)}),this.children.forEach(function(a,c){return a.setColumnWidth(b.childrenWidths[c],!0)})},updateWeights:function(a){this.childrenWeights=a,this.scale.domain([0,b.sum(this.childrenWeights)]);var c=this;this.childrenWidths=this.childrenWeights.map(function(a){return c.scale(a)}),this.columnWidth=b.sum(this.childrenWidths),this.children.forEach(function(a,b){return a.setColumnWidth(c.childrenWidths[b],!0)})},removeChild:function(c){var d=this.children.indexOf(c),e=this;this.childrenWeights.splice(d,1),this.childrenWidths.splice(d,1),this.columnWidth=b.sum(this.childrenWidths),this.scale.range([0,this.columnWidth]),this.scale.domain([0,b.sum(this.childrenWeights)]),this.children.splice(d,1),c.parent=null,this.children.length<1&&(this.emptyColumns=[new a.LayoutEmptyColumn({parent:e})],this.columnWidth=100)},addChild:function(c,d,e){if(!(c instanceof a.LayoutNumberColumn))return!1;var f=0;return d instanceof a.LayoutEmptyColumn?this.emptyColumns=[]:(f=this.children.indexOf(d),"r"===e&&f++),this.childrenWeights.splice(f,0,this.scale.invert(c.getColumnWidth())),this.childrenWidths.splice(f,0,c.getColumnWidth()),this.columnWidth=b.sum(this.childrenWidths),this.scale.range([0,this.columnWidth]),this.scale.domain([0,b.sum(this.childrenWeights)]),c.parent=this,this.children.splice(f,0,c),!0},description:function(){var a=l.prototype.description.call(this);a.type="stacked";var b=this;return a.children=this.children.map(function(a,c){var d=a.description();return d.weight=b.childrenWeights[c],d}),a.label=this.label,a},makeCopy:function(){var a=this,c=a.description();c.childrenLinks=[];var d=new t(c,{},a.toLayoutColumn);return d.children=a.children.map(function(a){return a.makeCopy()}),d.children.forEach(function(a){a.parent=d}),d.childrenWeights=this.childrenWeights.slice(0),d.scale.domain([0,b.sum(this.childrenWeights)]),d.childrenWidths=this.childrenWeights.map(function(b){return a.scale(b)}),d}}),a.LayoutEmptyColumn=u,u.prototype=c.extend({},l.prototype,{getLabel:function(){return this.label},getDataID:function(){return this.id},getValue:function(){return""}}),a.LayoutActionColumn=v,v.prototype=c.extend({},l.prototype,{getLabel:function(){return this.label},getDataID:function(){return this.id},description:function(){var a=l.prototype.description.call(this);return a.type="actions",a},getValue:function(){return""}})}(d||(d={}),b,a,c);var d;!function(a,b,c,d){function e(a,b,d,e){var f=400;e=c.extend({},e,{x:+a.node().clientWidth/2-f/2,y:0,width:f});var g=a.append("div").attr("class","lu-popupBG"),h=a.append("div").attr({"class":"lu-popup"}).style({left:e.x+"px",top:e.y+"px",width:e.width+"px"}).html('<span style="font-weight: bold">'+b+"</span>"+(d?'<input type="text" id="popupInputText" size="35" value="'+d+'"><br>':"")+'<div class="selectionTable"></div><button class="cancel"><i class="fa fa-times"></i> cancel</button><button class="ok"><i class="fa fa-check"></i> ok</button>'),i=h.select(".selectionTable").append("table");return h.select(".cancel").on("click",function(){g.remove(),h.remove()}),{popup:h,table:i,remove:function(){h.remove(),g.remove()},onOK:function(a){return h.select(".ok").on("click",a)}}}a.prototype=a.prototype||{},a.prototype.addNewStackedColumnDialog=function(){function b(){var a=g.table.selectAll("tr").data(h);a.select(".checkmark").html(function(a){return a.isChecked?'<i class="fa fa-check-square-o"></i>':'<i class="fa fa-square-o"></i>'}).on("click",function(a){a.isChecked=!a.isChecked,b()}),a.select(".datalabel").style("opacity",function(a){return a.isChecked?"1.0":".8"}),a.select(".weightInput").attr("disabled",function(a){return a.isChecked?null:!0})}function d(a){return c(f.$container.node()).find("#"+a)[0]}var f=this,g=e(this.$container,"Add stacked column:","Stacked"),h=f.storage.getRawColumns().filter(function(b){return b instanceof a.LineUpNumberColumn}).map(function(a){return{d:a,isChecked:!1,weight:1}}),i=g.table.selectAll("tr").data(h);i.enter().append("tr"),i.append("td").attr("class","checkmark"),i.append("td").attr("class","datalabel").style("opacity",.8).text(function(a){return a.d.label}),i.append("td").append("input").attr({"class":"weightInput",type:"text",value:function(a){return a.weight},disabled:!0,size:5}).on("input",function(a){a.weight=+this.value,b()}),b(),g.onOK(function(){var a=d("popupInputText").value;if(a.length<1)return void window.alert("name must not be empty");var b=h.filter(function(a){return a.isChecked}),c={label:a,width:Math.max(100*b.length,100),children:b.map(function(a){return{column:a.d.column,type:"number",weight:a.weight}})};f.storage.addStackedColumn(c),g.remove(),f.headerUpdateRequired=!0,f.listeners["columns-changed"](f),f.updateAll()})},a.prototype.addNewSingleColumnDialog=function(){function a(){var b=c.table.selectAll("tr").data(f);b.select(".checkmark").html(function(a){return'<i class="fa fa-'+(a.isChecked?"check-":"")+'square-o"></i>'}).on("click",function(b){b.isChecked=!b.isChecked,a()}),b.select(".datalabel").style("opacity",function(a){return a.isChecked?"1.0":".8"})}var b=this,c=e(this.$container,"add single columns",d),f=b.storage.getRawColumns().map(function(a){return{d:a,isChecked:!1,weight:1}}),g=c.table.selectAll("tr").data(f);g.enter().append("tr"),g.append("td").attr("class","checkmark"),g.append("td").attr("class","datalabel").style("opacity",.8).text(function(a){return a.d.label}),a(),c.onOK(function(){var a=f.filter(function(a){return a.isChecked});a.forEach(function(a){b.storage.addSingleColumn({column:a.d.column})}),c.remove(),a.length&&b.listeners["columns-changed"](b),b.headerUpdateRequired=!0,b.updateAll()})},a.prototype.reweightStackedColumnWidget=function(a,c){function d(){var d=c.selectAll("tr").data(a);f.domain([0,b.max(a,e)]),d.select(".predictBar").transition().style({width:function(a){return f(a.weight)+"px"}})}var e=function(a){return a.weight},f=b.scale.linear().domain([0,b.max(a,e)]).range([0,120]),g=c.selectAll("tr").data(a),h=this.config;g.enter().append("tr"),g.append("td").style({width:"20px"}).append("input").attr({"class":"weightInput",type:"text",value:function(a){return a.weight},size:5}).on("input",function(b){a[b.index].weight=+this.value,d()}),g.append("td").append("div").attr("class","predictBar").style({width:function(a){return f(a.weight)+"px"},height:"20px","background-color":function(a){return h.colorMapping.get(a.dataID)}}),g.append("td").attr("class","datalabel").text(function(a){return a.d}),d()},a.prototype.reweightStackedColumnDialog=function(a){var b=this,c=e(this.$container,'re-weight column "'+a.label+'"',d),f=a.children.map(function(b,c){return{d:b.column.label,dataID:b.getDataID(),weight:+a.childrenWeights[c],index:c}});this.reweightStackedColumnWidget(f,c.table),c.onOK(function(){c.remove(),b.changeWeights(a,f.map(function(a){return a.weight}))})},a.prototype.openMappingEditor=function(b,e){function f(a){k=a,b.mapping(k);var c=p.node().checked;c?b.filter=a.domain():b.filter=d,e.classed("filtered",!g(k.range(),i.range())||!g(k.domain(),i.domain())),j.listeners["change-filter"](j,b),j.config.filtering&&j.config.filtering.external||j.storage.resortData({filteredChanged:!0}),j.updateAll(!0)}function g(a,b){return 0===c(a).not(b).length&&0===c(b).not(a).length}var h=b.mapping(),i=b.originalMapping(),j=this,k=h,l=this.$container.node().clientHeight,m=Math.max(270,Math.min(l/2,470)),n=this.$container.append("div").attr("class","lu-popupBG"),o=this.$container.append("div").attr({"class":"lu-popup"}).style({left:+this.$container.node().clientWidth/2-100+"px",top:"0px",width:m-50+"px",height:m+"px"}).html('<div style="font-weight: bold"> change mapping: </div><div class="mappingArea"></div><label><input type="checkbox" id="filterIt" value="filterIt">Filter Outliers</label><br><button class="cancel"><i class="fa fa-times"></i> cancel</button><button class="reset"><i class="fa fa-undo"></i> revert</button><button class="ok"><i class="fa fa-check"></i> ok</button>'),p=o.select("input").on("change",function(){f(k)});p.node().checked=Array.isArray(b.filter);var q=function(a){return+b.getValue(a,"raw")},r={callback:f,triggerCallback:"dragend",width:m-50,height:m-50},s=a.mappingEditor(h,i.domain(),j.storage.rawdata,q,r);o.select(".mappingArea").call(s),o.select(".ok").on("click",function(){f(k),o.remove(),n.remove()}),o.select(".cancel").on("click",function(){b.mapping(h),e.classed("filtered",!g(h.range(),i.range())||!g(h.domain(),i.domain())),o.remove(),n.remove()}),o.select(".reset").on("click",function(){k=h=i,f(i),s=a.mappingEditor(h,i.domain(),j.storage.rawdata,q,r),o.selectAll(".mappingArea *").remove(),o.select(".mappingArea").call(s)})},a.prototype.stackedColumnOptionsGui=function(a){function b(a){g.storage.removeColumn(a),g.listeners["columns-changed"](g),g.headerUpdateRequired=!0,g.updateAll()}function d(a){function b(a){return c(g.$container.node()).find("#"+a)[0]}var d=+this.$container.node().clientWidth/2-100,e=0,f=this.$container.append("div").attr("class","lu-popupBG"),h=this.$container.append("div").attr({"class":"lu-popup"}).style({left:d+"px",top:e+"px",width:"200px",height:"70px"}).html('<div style="font-weight: bold"> rename column: </div><input type="text" id="popupInputText" size="20" value="'+a.label+'"><br><button class="cancel"><i class="fa fa-times"></i> cancel</button><button class="ok"><i class="fa fa-check"></i> ok</button>');h.select(".ok").on("click",function(){var c=b("popupInputText").value;c.length>0?(a.label=c,g.updateHeader(g.storage.getColumnLayout(a.columnBundle)),h.remove(),f.remove()):window.alert("non empty string required")}),h.select(".cancel").on("click",function(){h.remove(),f.remove()})}var e=this.config,f=this.$header.select(".overlay"),g=this,h=this.stackedColumnModified===a;if(h)return f.selectAll(".stackedOption").remove(),void(this.stackedColumnModified=null);this.stackedColumnModified=a;var i=[{name:" remove",action:b},{name:" rename",action:d},{name:" re-weight",action:g.reweightStackedColumnDialog}],j=100*i.length,k=f.selectAll(".stackedOption").data([{d:a,o:i}]);k.exit().remove();var l=k.enter().append("g").attr({"class":"stackedOption",transform:function(a){return"translate("+(a.d.offsetX+a.d.columnWidth-j)+","+(e.htmlLayout.headerHeight/2-2)+")"}});l.append("rect").attr({x:0,y:0,width:j,height:e.htmlLayout.headerHeight/2-4}),l.selectAll("text").data(function(a){return a.o}).enter().append("text").attr({x:function(a,b){return 100*b+5},y:e.htmlLayout.headerHeight/4-2}).text(function(a){return a.name}),k.selectAll("text").on("click",function(b){f.selectAll(".stackedOption").remove(),b.action.call(g,a)}),k.transition().attr({transform:function(a){return"translate("+(a.d.offsetX+a.d.columnWidth-j)+","+(e.htmlLayout.headerHeight/2-2)+")"}})},a.prototype.openCategoricalFilterPopup=function(b,c){function d(){var a=h.select("tbody").selectAll("tr").data(j);a.select(".checkmark").html(function(a){return'<i class="fa fa-'+(a.isChecked?"check-":"")+'square-o"></i>'}).on("click",function(a){a.isChecked=!a.isChecked,d()}),a.select(".datalabel").style("opacity",function(a){return a.isChecked?"1.0":".8"})}function e(a){b.filter=a,c.classed("filtered",a&&a.length>0&&a.length<b.column.categories.length),i.listeners["change-filter"](i,b),i.config.filtering&&i.config.filtering.external||i.storage.resortData({filteredChanged:!0}),i.updateBody()}if(b instanceof a.LayoutCategoricalColumn){var f=b.filter||[],g=this.$container.append("div").attr("class","lu-popupBG"),h=this.$container.append("div").attr({"class":"lu-popup"}).style({left:+this.$container.node().clientWidth/2-100,top:"0px",width:"400px",height:"300px"}).html('<span style="font-weight: bold">Edit Filter</span><form onsubmit="return false"><div class="selectionTable"><table><thead><th></th><th>Category</th></thead><tbody></tbody></table></div><button class="ok"><i class="fa fa-check" title="ok"></i></button><button class="cancel"><i class="fa fa-times" title="cancel"></i></button><button class="reset"><i class="fa fa-undo" title="reset"></i></button></form>');h.select(".selectionTable").style({width:"390px",height:"260px"});var i=this,j=b.column.categories.map(function(a){return{d:a,isChecked:0===f.length||f.indexOf(a)>=0}}),k=h.select("tbody").selectAll("tr").data(j);k.enter().append("tr"),k.append("td").attr("class","checkmark"),k.append("td").attr("class","datalabel").text(function(a){return a.d}),d(),h.select(".cancel").on("click",function(){e(f),h.remove(),g.remove()}),h.select(".reset").on("click",function(){j.forEach(function(a){a.isChecked=!0}),d(),e(null)}),h.select(".ok").on("click",function(){var a=j.filter(function(a){return a.isChecked}).map(function(a){return a.d});a.length===b.column.categories.length&&(a=[]),e(a),h.remove(),g.remove()})}},a.prototype.openFilterPopup=function(b,d){function e(a){b.filter=a,d.classed("filtered",a&&a.length>0),k.listeners["change-filter"](k,b),k.config.filtering&&k.config.filtering.external||k.storage.resortData({filteredChanged:!0}),k.updateBody()}function f(a){return c(k.$container.node()).find("#"+a)[0]}if(b instanceof a.LayoutStringColumn){var g={left:b.offsetX,top:0},h=b.filter||"",i=this.$container.append("div").attr("class","lu-popupBG"),j=this.$container.append("div").attr({"class":"lu-popup2"}).style({left:g.left+"px",top:g.top+"px"}).html('<form onsubmit="return false"><input type="text" id="popupInputText" placeholder="containing..." autofocus="true" size="18" value="'+h+'"><br><button class="ok"><i class="fa fa-check" title="ok"></i></button><button class="cancel"><i class="fa fa-times" title="cancel"></i></button><button class="reset"><i class="fa fa-undo" title="reset"></i></button></form>'),k=this;j.select(".cancel").on("click",function(){f("popupInputText").value=h,e(h),j.remove(),i.remove()}),j.select(".reset").on("click",function(){f("popupInputText").value="",e(null)}),j.select(".ok").on("click",function(){e(f("popupInputText").value),j.remove(),i.remove()})}},a.createTooltip=function(a){function b(a,b){i.html(a).css({left:b.x+"px",top:b.y+b.height-h.offset().top+"px"}).fadeIn();var d=c(window).height()+c(window).scrollTop()<=b.y+b.height+i.height()-20,e=c(window).scrollTop()>b.y-i.height();d&&!e&&i.css("top",b.y-i.height()-h.offset().top+"px")}function d(){i.stop(!0).hide()}function e(a){a.x&&i.css({left:a.x+"px"}),a.y&&i.css({top:a.y-h.offset().top+"px"})}function f(){return[i.width(),i.height()]}function g(){i.remove()}var h=c(a),i=c('<div class="lu-tooltip"/>').appendTo(h);return{show:b,hide:d,move:e,size:f,destroy:g}},a.prototype.initScrolling=function(a,b){function d(){var a=h.scrollTop,b=h.scrollLeft;g.scrolled(a,b),Math.abs(j-a)>=i*(l/2)&&(j=a,g.updateBody())}function e(b,c){var d,e=h.scrollTop-f,g=e+a.innerHeight(),j=0;if(e>0){for(j=Math.round(e/i);j>=0&&c(b[j+1])>e;)j--;j-=l}for(d=Math.round(g/i);d<=b.length&&c(b[d-1])<g;)d++;return d+=l,[Math.max(j,0),Math.min(d,b.length)]}var f,g=this,h=a[0],i=this.config.svgLayout.rowHeight,j=h.scrollTop,k=c(this.$table.node()),l=this.config.svgLayout.backupScrollRows;return a.on("scroll",d),f=k.offset().top-a.offset().top+b,{selectVisible:e,onScroll:d}},a.prototype.initDragging=function(){function c(){b.event.sourceEvent.stopPropagation(),b.select(this).classed("dragging",!0)}function d(){var a=Math.max(b.mouse(this.parentNode)[0],2);
f.reweightHeader({column:b.select(this).data()[0],value:a}),f.updateBody(f.storage.getColumnLayout(),f.storage.getData(),!1)}function e(){b.select(this).classed("dragging",!1),f.config.columnBundles.primary.sortedColumn instanceof a.LayoutStackedColumn&&(f.listeners["change-sortcriteria"](f,f.config.columnBundles.primary.sortedColumn),f.config.sorting&&f.config.sorting.external||f.storage.resortData({column:f.config.columnBundles.primary.sortedColumn}),f.updateBody(f.storage.getColumnLayout(),f.storage.getData(),!1))}var f=this;return b.behavior.drag().origin(function(a){return a}).on("dragstart",c).on("drag",d).on("dragend",e)}}(d||(d={}),b,a);var d;!function(a,b,c){"use strict";function d(a,b,c,d,e,f){return a.append("line").attr({x1:b,y1:c,x2:d,y2:e,"class":f})}function e(a,b,c,d,e,f){return e=e||null,f=f||null,a.append("text").attr({x:b,y:c,dy:e,"class":f}).text(d)}function f(a,b,c,d,e){return c-=b,a.append("circle").attr({"class":"handle",r:e,cx:b,cy:d,transform:"translate("+c+",0)"})}a.mappingEditor=function(a,g,h,i,j){j=c.extend({width:400,height:400,padding:50,radius:10,callback:c.noop,callbackThisArg:null,triggerCallback:"change"},j);var k=function(c){function k(a,c){return b.behavior.drag().on("dragstart",function(){b.select(this).classed("dragging",!0).attr("r",1.1*j.radius),a.style("visibility","visible")}).on("drag",c).on("dragend",function(){b.select(this).classed("dragging",!1).attr("r",j.radius),a.style("visibility",null),n(!0)}).origin(function(){var a=b.transform(b.select(this).attr("transform"));return{x:a.translate[0],y:a.translate[1]}})}function l(){a.range([v,w]),A.attr("x1",function(b){return a(i(b))}),n()}function m(){var b,c;y>x?(b=A.filter(function(a){return t(i(a))<x||t(i(a))>y}),c=A.filter(function(a){return!(t(i(a))<x||t(i(a))>y)})):(b=A.filter(function(a){return t(i(a))>x||t(i(a))<y}),c=A.filter(function(a){return!(t(i(a))>x||t(i(a))<y)})),b.style("visibility","hidden"),a.domain([t.invert(x),t.invert(y)]),c.style("visibility",null).attr("x1",function(b){return a(i(b))}),n()}function n(a){if(a===("dragend"===j.triggerCallback)){var c=b.scale.linear().domain([t.invert(x),t.invert(y)]).range([u.invert(v),u.invert(w)]);j.callback.call(j.callbackThisArg,c)}}var o=c.append("svg").attr({"class":"lugui-me",width:j.width,height:j.height}),p=j.padding,q=j.width-j.padding,r=j.padding,s=j.height-j.padding,t=b.scale.linear().domain(g).range([p,q]),u=b.scale.linear().domain([0,1]).range([p,q]),v=u(a.range()[0]),w=u(a.range()[1]),x=t(a.domain()[0]),y=t(a.domain()[1]);a=b.scale.linear().clamp(!0).domain(a.domain()).range([v,w]);var z=o.append("g");d(z,p,r,q,r,"axis"),e(z,p,r-25,0,".75em"),e(z,q,r-25,1,".75em"),e(z,j.width/2,r-25,"Score",".75em","centered"),d(z,p,s,q,s,"axis"),e(z,p,s+20,g[0],".75em"),e(z,q,s+20,g[1],".75em"),e(z,j.width/2,s+20,"Raw",".75em","centered");var A=o.append("g").classed("data",!0).selectAll("line").data(h);A.enter().append("line").attr({x1:function(b){return a(i(b))},y1:r,x2:function(a){return t(i(a))},y2:s}).style("visibility",function(a){var b;return b=y>x?t(i(a))<x||t(i(a))>y:t(i(a))>x||t(i(a))<y,b?"hidden":null});var B=d(o,v,r,x,s,"bound"),C=d(o,w,r,y,s,"bound"),D=e(o,p+5,r-15,b.round(u.invert(v),2),".25em","drag").attr("transform","translate("+(v-p)+",0)"),E=e(o,p+5,s-15,b.round(t.invert(x),2),".25em","drag").attr("transform","translate("+(x-p)+",0)"),F=e(o,q+5,r-15,b.round(u.invert(w),2),".25em","drag").attr("transform","translate("+(w-q)+",0)"),G=e(o,q+5,s-15,b.round(t.invert(y),2),".25em","drag").attr("transform","translate("+(y-q)+",0)");f(o,p,v,r,j.radius).call(k(D,function(){b.event.x>=0&&b.event.x<=q-p&&(B.attr("x1",p+b.event.x),b.select(this).attr("transform","translate("+b.event.x+", 0)"),v=b.event.x+p,D.text(b.round(u.invert(v),2)).attr("transform","translate("+b.event.x+", 0)"),l())})),f(o,q,w,r,j.radius).call(k(F,function(){b.event.x>=-1*(q-p)&&b.event.x<=0&&(C.attr("x1",q+b.event.x),b.select(this).attr("transform","translate("+b.event.x+", 0)"),w=b.event.x+q,F.text(b.round(u.invert(w),2)).attr("transform","translate("+b.event.x+", 0)"),l())})),f(o,p,x,s,j.radius).call(k(E,function(){b.event.x>=0&&b.event.x<=q-p&&(B.attr("x2",p+b.event.x),b.select(this).attr("transform","translate("+b.event.x+", 0)"),x=b.event.x+p,E.text(b.round(t.invert(x),2)).attr("transform","translate("+b.event.x+", 0)"),m())})),f(o,q,y,s,j.radius).call(k(G,function(){b.event.x>=-1*(q-p)&&b.event.x<=0&&(C.attr("x2",q+b.event.x),b.select(this).attr("transform","translate("+b.event.x+", 0)"),y=b.event.x+q,G.text(b.round(t.invert(y),2)).attr("transform","translate("+b.event.x+", 0)"),m())}))};return k}}(d||(d={}),b,a);var d;!function(a,b,c,d,e){function f(b){return function c(d){d.columnBundle=b,d instanceof a.LayoutStackedColumn&&d.children.forEach(c)}}function g(d,e,f,h,i){function j(a){return new l[a.type](a,j,d)}function k(b){var c=b.type||"single";if("single"===c){var d=o.get(b.column);d instanceof a.LineUpNumberColumn?c="number":d instanceof a.LineUpCategoricalColumn&&(c="categorical")}return new m[c](b,o,k,n)}this.storageConfig=c.extend(!0,{},{colTypes:{number:a.LineUpNumberColumn,string:a.LineUpStringColumn,categorical:a.LineUpCategoricalColumn},layoutColumnTypes:{number:a.LayoutNumberColumn,single:a.LayoutStringColumn,string:a.LayoutStringColumn,categorical:a.LayoutCategoricalColumn,categoricalcolor:a.LayoutCategoricalColorColumn,stacked:a.LayoutStackedColumn,rank:a.LayoutRankColumn,actions:a.LayoutActionColumn}},i),this.config=null;var l=this.storageConfig.colTypes,m=this.storageConfig.layoutColumnTypes,n=this;this.storageConfig.toColumn=j,this.primaryKey=h,this.rawdata=d,this.selected=b.set(),this.rawcols=e.map(j),this.layout=f||g.generateDefaultLayout(this.rawcols);var o=b.map();this.rawcols.forEach(function(a){o.set(a.column,a)}),this.storageConfig.toLayoutColumn=k;var p=this.bundles={};Object.keys(this.layout).forEach(function(a){p[a]={layoutColumns:[],needsLayout:!0,data:d,initialSort:!0}})}a.LineUpLocalStorage=g,a.createLocalStorage=function(a,b,c,d,e){return new g(a,b,c,d,e)},g.generateDefaultLayout=function(b){var c=b.map(function(b){return{column:b.column,width:b instanceof a.LineUpStringColumn?200:100}});return{primary:c}},g.prototype=c.extend({},{},{getRawColumns:function(){return this.rawcols},getColumnLayout:function(a){var b=a||"primary";return this.bundles[b].needsLayout&&(this.generateLayout(this.layout,b),this.bundles[b].needsLayout=!1),this.bundles[b].layoutColumns},isSelected:function(a){return this.selected.has(a[this.primaryKey])},select:function(a){this.selected.add(a[this.primaryKey])},selectAll:function(a){var b=this;a.forEach(function(a){b.selected.add(a[b.primaryKey])})},setSelection:function(a){this.clearSelection(),this.selectAll(a)},deselect:function(a){this.selected.remove(a[this.primaryKey])},selectedRows:function(){return this.rawdata.filter(this.isSelected.bind(this))},clearSelection:function(){this.selected=b.set()},getData:function(a){return a=a||"primary",this.bundles[a].data},filterData:function(a){var b=[];return a.forEach(function(a){a.flattenMe(b)}),b=b.filter(function(a){return a.isFiltered()}),c.isFunction(this.config.filter.filter)&&b.push(this.config.filter.filter),0===b.length?this.rawdata:this.rawdata.filter(function(a){return b.every(function(b){return b.filterBy(a)})})},resortData:function(c){function d(a,c){var d=i.sortBy(a,c);return 0===d||isNaN(d)?b.ascending(a[m],c[m]):h?-d:d}var e=c.key||"primary",f=this,g=this.bundles[e],h=c.asc||this.config.columnBundles[e].sortingOrderAsc,i=c.column||this.config.columnBundles[e].sortedColumn,j=this.getColumnLayout(e);if(g.data=this.filterData(j),c.filteredChanged||g.initialSort){var k=[];j.forEach(function(a){a.flattenMe(k)});var l=f.config.histograms&&f.config.histograms.generator;k.forEach(function(a){a.prepare(g.data,f.config.renderingOptions.histograms,l)}),g.initialSort=!1}var m=this.primaryKey;i&&g.data.sort(d);var n=this.config.filter.skip?this.config.filter.skip:0;this.config.filter.limit&&isFinite(this.config.filter.limit)?g.data=g.data.slice(n,n+this.config.filter.limit):g.data=g.data.slice(n);var o=g.layoutColumns.filter(function(b){return b instanceof a.LayoutRankColumn});if(o.length>0){var p=function(a,b){return b};i&&(p=function(a){return i.getValue(a)}),this.assignRanks(g.data,p,o)}},assignRanks:function(a,b,c){var d=1,e=-1;a.forEach(function(a,f){-1===e&&(e=b(a,f)),e!==b(a,f)&&(d=f+1,e=b(a,f)),c.forEach(function(b){b.setValue(a,d)})})},generateLayout:function(b,c){var d=c||"primary",e=this.bundles[d];e.layoutColumns=b[d].map(this.storageConfig.toLayoutColumn),e.layoutColumns.filter(function(b){return b instanceof a.LayoutRankColumn}).length<1&&e.layoutColumns.unshift(new a.LayoutRankColumn(null,null,null,this)),this.config.svgLayout.rowActions.length>0&&e.layoutColumns.filter(function(b){return b instanceof a.LayoutActionColumn}).length<1&&e.layoutColumns.push(new a.LayoutActionColumn),e.layoutColumns.forEach(f(d))},addColumn:function(b,c,d){var e,f,g=c||"primary",h=this.bundles[g].layoutColumns;if("undefined"==typeof d||null===d)for(e=0;e<h.length&&(f=h[e],f instanceof a.LayoutRankColumn||f instanceof a.LayoutStringColumn);++e);else 0>d&&(d=h.length+1+d),e=Math.max(0,Math.min(h.length,d));b.columnBundle=g,h.splice(e,0,b)},addStackedColumn:function(a,b,d){var e=c.extend({type:"stacked",label:"Stacked",children:[]},a);this.addColumn(this.storageConfig.toLayoutColumn(e),d,b)},addSingleColumn:function(a,b,c){this.addColumn(this.storageConfig.toLayoutColumn(a),c,b)},removeColumn:function(b){var c=this.bundles[b.columnBundle].layoutColumns;if(b instanceof a.LayoutStackedColumn){var f=d.indexOf(c,b);if(f!==e){var g=[];Array.prototype.splice.apply(c,[f,1].concat(g))}}else b.column&&(null===b.parent||b.parent===e?c.splice(c.indexOf(b),1):(b.parent.removeChild(b),this.resortData({})))},moveColumn:function(a,b,c){var d,e=this.bundles[a.columnBundle].layoutColumns,g=this.bundles[b.columnBundle].layoutColumns;null==a.parent&&null==b.parent?(e.splice(e.indexOf(a),1),d=g.indexOf(b),"r"===c&&d++,g.splice(d,0,a)):null!==a.parent&&null===b.parent?(a.parent.removeChild(a),d=g.indexOf(b),"r"===c&&d++,g.splice(d,0,a)):null===a.parent&&null!==b.parent?b.parent.addChild(a,b,c)&&e.splice(e.indexOf(a),1):null!==a.parent&&null!==b.parent&&(a.parent.removeChild(a),b.parent.addChild(a,b,c)),f(b.columnBundle)(a),this.resortData({})},copyColumn:function(a,b,c){var d=this.bundles[b.columnBundle].layoutColumns,e=a.makeCopy();if(f(b.columnBundle)(e),null==b.parent){var g=d.indexOf(b);"r"===c&&g++,d.splice(g,0,e)}else null!==b.parent&&b.parent.addChild(e,b,c);this.resortData({})},getColumnByName:function(a){for(var b=this.getColumnLayout(),c=b.length-1;c>=0;--c){var d=b[c];if(d.getLabel()===a||d.column&&d.column.column===a)return d}return null}})}(d||(d={}),b,a,c);var d;!function(a,b,c,d){function e(b,c,d,e,f){var g=b.filter(function(b){return b instanceof a.LayoutCategoricalColumn||b instanceof a.LayoutStringColumn||b instanceof a.LayoutRankColumn}),h=e.svgLayout.rowHeight/2,i=c.selectAll(".tableData.text").data(function(b){var c=g.map(function(c){return{value:c.getValue(b),label:c.getValue(b,"raw"),offsetX:c.offsetX,columnW:c.getColumnWidth(),isRank:c instanceof a.LayoutRankColumn,clip:"url("+f+"#clip-B"+c.id+")"}});return c});i.enter().append("text").attr({"class":function(a){return"tableData text"+(a.isRank?" rank":"")},y:h,"clip-path":function(a){return a.clip}}),i.exit().remove(),i.attr("x",function(a){return a.offsetX}).attr({"clip-path":function(a){return a.clip}}).text(function(a){return a.label}),c.selectAll(".tableData.text.rank").text(function(a){return a.label})}function f(b,c,d,e){var f=b.filter(function(b){return b instanceof a.LayoutCategoricalColorColumn}),g=e.svgLayout.rowHeight-2*e.svgLayout.rowBarPadding,h=c.selectAll(".tableData.cat").data(function(a){var b=f.map(function(b){return{value:b.getValue(a),label:b.getValue(a,"raw"),offsetX:b.offsetX,columnW:b.getColumnWidth(),color:b.getColor(a),clip:"url(#clip-B"+b.id+")"}});return b});h.enter().append("rect").attr({"class":"tableData cat",y:e.svgLayout.rowBarPadding,height:e.svgLayout.rowHeight-2*e.svgLayout.rowBarPadding,width:g}).append("title"),h.exit().remove(),h.attr("x",function(a){return a.offsetX+2}).style("fill",function(a){return a.color}).select("title").text(function(a){return a.label})}function g(b){if(!b.renderingOptions.stacked||b.renderingOptions.values)return!1;var c=b.columnBundles.primary.sortedColumn;return!(c&&c.parent instanceof a.LayoutStackedColumn)}function h(b,c,d){var e=b.filter(function(b){return b.column instanceof a.LineUpNumberColumn}),f=c.selectAll(".tableData.bar").data(function(a){var b=e.map(function(b){return{key:b.getDataID(),value:b.getWidth(a),label:b.column.getRawValue(a),offsetX:b.offsetX}});return b});f.enter().append("rect").attr({"class":"tableData bar",y:d.svgLayout.rowBarPadding,height:d.svgLayout.rowHeight-2*d.svgLayout.rowBarPadding}),f.exit().remove(),f.attr({x:function(a){return a.offsetX},width:function(a){return Math.max(+a.value-2,0)}}).style({fill:function(a){return d.colorMapping.get(a.key)}})}function i(b,c,d,e){var f=b.filter(function(b){return b instanceof a.LayoutStackedColumn}),h=c.selectAll(".tableData.stacked").data(function(a){var b=f.map(function(b){return{key:b.getDataID(),childs:b.children,parent:b,row:a}});return b});h.exit().remove(),h.enter().append("g").attr("class","tableData stacked"),h.attr("transform",function(a){return"translate("+a.parent.offsetX+",0)"});var i=0,j=0,k={},l=g(e),m=h.selectAll("rect").data(function(a){return i=0,j=0,a.childs.map(function(b){return j=b.getWidth(a.row),k={child:b,width:j,offsetX:i},i+=l?j:b.getColumnWidth(),k})});m.exit().remove(),m.enter().append("rect").attr({y:e.svgLayout.rowBarPadding,height:e.svgLayout.rowHeight-2*e.svgLayout.rowBarPadding}),(d?m.transition(e.svgLayout.animationDuration):m).attr({x:function(a){return a.offsetX},width:function(a){return a.width>2?a.width-2:a.width}}).style({fill:function(a){return e.colorMapping.get(a.child.getDataID())}})}function j(a,b,c){var d=a.selectAll("text").data(c.svgLayout.rowActions);d.enter().append("text").append("title"),d.exit().remove(),d.attr("x",function(a,b){return b*c.svgLayout.rowHeight}).text(function(a){return a.icon}).on("click",function(a){a.action.call(this,b.data,a)}).select("title").text(function(a){return a.name})}function k(c,d,e){var f=c.filter(function(b){return b instanceof a.LayoutActionColumn}),g=d.selectAll(".tableData.action").data(function(a){var b=f.map(function(b){return{key:b.getDataID(),value:b.getColumnWidth(a),data:a,offsetX:b.offsetX}});return b});g.enter().append("g").attr("class","tableData action").each(function(a){j(b.select(this),a,e)}),g.exit().remove(),g.attr("transform",function(a){return"translate("+(a.offsetX+10)+","+(.5*e.svgLayout.rowHeight+1)+")"})}function l(b,c){var d=b.getValue(c,"raw");return(b instanceof a.LayoutNumberColumn||b instanceof a.LayoutStackedColumn)&&(d=null===d||"undefined"==typeof d?0:isNaN(d)||""===d.toString()?"":+d),d}function m(a,b,d){var e=c("<div><table><thead><tr><th>Column</th><th>Value</th></tr></thead><tbody></tbody></table></div>"),f=e.find("tbody");return b.forEach(function(b){var e=l(b,a);"undefined"==typeof e?e="":"number"==typeof e&&(e=d.numberformat(e)),c("<tr><th>"+b.getLabel()+"</th><td>"+e+"</td></tr>").appendTo(f)}),e.html()}a.prototype=a.prototype||{},a.updateClipPaths=function(a,b,c,d,e){e=e||"column";var f=b.select("defs."+e).selectAll(function(){return this.getElementsByTagName("clipPath")}).data(a,function(a){return a.id});f.enter().append("clipPath").attr("id",function(a){return"clip-"+c+a.id}).append("rect").attr({y:0,height:"1000"}),f.exit().remove(),f.select("rect").attr({x:function(a){return d?a.offsetX:null},width:function(a){return Math.max(a.getColumnWidth()-5,0)}})},a.prototype.select=function(a){var b=this.storage.primaryKey,c=this.$body.selectAll(".row");Array.isArray(a)?(this.storage.setSelection(a),a=a.map(function(a){return a[b]}),c.classed("selected",function(c){return a.indexOf(c[b])>=0})):a?(this.storage.setSelection([a]),c.classed("selected",function(c){return c[b]===a[b]})):(this.storage.clearSelection(),c.classed("selected",!1))},a.prototype.updateBody=function(c,d,j){function l(b){function d(a){return isNaN(a)||""===a||"undefined"==typeof a?"":p.config.numberformat(+a)}var e=[];return c.forEach(function(c){if(c.column instanceof a.LineUpNumberColumn)e.push({id:c.id,value:c.getValue(b),label:p.config.numberformat(+c.getValue(b,"raw")),x:c.offsetX,w:c.getColumnWidth()});else if(c instanceof a.LayoutStackedColumn){var f=0;c.children.forEach(function(a){var g=a.getWidth(b);e.push({id:a.id,label:d(a.getValue(b,"raw"))+" -> ("+r(a.getWidth(b))+")",w:C?g:a.getColumnWidth(),x:f+c.offsetX}),f+=C?g:a.getColumnWidth()})}}),e}function n(a,b,c,d,e){var f=a.selectAll("text."+c);f.data(b).enter().append("text").attr({"class":"tableData "+c,x:function(a){return a.x},y:p.config.svgLayout.rowHeight/2,"clip-path":function(a){return"url("+(e||"")+"#clip-"+d+a.id+")"}}).text(function(a){return a.label}),f.attr({x:function(a){return a.x},y:p.config.svgLayout.rowHeight/2,"clip-path":function(a){return"url("+(e||"")+"#clip-"+d+a.id+")"}})}if(!Array.isArray(c)||0!==c.length){c=c||this.storage.getColumnLayout(),d=d||this.storage.getData(c[0].columnBundle),j=j||!1;var o=this.$body,p=this,q=this.storage.primaryKey,r=b.format(".1f"),s=this.config.columnBundles[c[0].columnBundle];j=j||!1;var t=[];c.forEach(function(a){a.flattenMe(t)});var u=d.length,v=d,w=b.scale.ordinal().domain(d.map(function(a){var b=a[q];return null===b||"undefined"==typeof b?"":b})).rangeBands([0,u*p.config.svgLayout.rowHeight],0,p.config.svgLayout.rowPadding),x=s.prevRowScale||w;s.prevRowScale=w;var y=0;"combined"===p.config.svgLayout.mode&&(y=p.config.htmlLayout.headerHeight),this.$bodySVG.attr("height",u*p.config.svgLayout.rowHeight+y);var z=this.selectVisible(d,w);(z[0]>0||z[1]<d.length)&&(d=d.slice(z[0],z[1]));var A=o.selectAll(".row").data(d,function(a){return a[q]});A.exit().remove();var B=A.enter().append("g").attr({"class":"row",transform:function(a){var b=x(a[q]);if("undefined"==typeof b){var c=w.range();b=c&&c.length>0?c[c.length-1]:0}return"translate(0,"+b+")"}});B.append("rect").attr({"class":"filler",width:"100%",height:p.config.svgLayout.rowHeight}),(this.config.renderingOptions.animation?A.transition().duration(this.config.svgLayout.animationDuration):A).attr({transform:function(a){var b=a[q];return"translate(0,"+(null===b||"undefined"==typeof b?0:w(b))+")"}});var C=g(this.config);A.on({mouseenter:function(a){function c(a){var b=document.documentElement.scrollTop||document.body.scrollTop,c=a.getScreenCTM(),d=a.getBBox(),e=p.$bodySVG.node().createSVGPoint();return e.x=d.x,e.y=d.y,e=e.matrixTransform(c),b+e.y}var d=b.select(this);d.classed("hover",!0);var e=l(a),f=w(a[q]),g=p.$bodySVG.select("defs.overlay").selectAll(function(){return this.getElementsByTagName("clipPath")}).data(e);g.enter().append("clipPath").append("rect").attr({height:"1000"}),g.exit().remove(),g.attr("y",f).attr("id",function(a){return"clip-M"+a.id}),g.select("rect").attr({x:function(a){return a.x},width:function(a){return Math.max(a.w-2,0)}}),n(d,e,"hoveronly","M",p.getClipSource.apply(this)),p.config.interaction.tooltips&&p.tooltip.show(m(a,t,p.config),{x:b.mouse(p.$container.node())[0]+10,y:c(this),height:p.config.svgLayout.rowHeight}),p.hoverHistogramBin(a),p.listeners.hover(a,f)},mousemove:function(){p.config.interaction.tooltips&&p.tooltip.move({x:b.mouse(p.$container.node())[0]})},mouseleave:function(){p.config.interaction.tooltips&&p.tooltip.hide(),p.hoverHistogramBin(null),p.listeners.hover(null),b.select(this).classed("hover",!1),b.select(this).selectAll("text.hoveronly").remove()},click:function(a){var c=b.select(this),d=p.storage.isSelected(a);if(p.config.interaction.multiselect(b.event)){var e=p.storage.selectedRows();if(d)c.classed("selected",!1),p.storage.deselect(a),1===e.length&&p.listeners.selected(null),e.splice(e.indexOf(a),1);else{if(c.classed("selected",!0),p.storage.select(a),p.config.interaction.rangeselect(b.event)&&1===e.length){var f=v.indexOf(a),g=v.indexOf(e[0]);e=g>f?v.slice(f,g+1):v.slice(g,f+1);var h=A.filter(function(a){return e.indexOf(a)>=0}).classed("selected",!0).data();p.storage.selectAll(h)}else e.push(a);1===e.length&&p.listeners.selected(a,null)}p.listeners.multiselected(e)}else if(d)c.classed("selected",!1),p.storage.deselect(a),p.listeners.selected(null),p.listeners.multiselected([]);else{var i=A.filter(".selected").classed("selected",!1);i=i.empty?null:i.datum(),c.classed("selected",!0),p.storage.setSelection([a]),p.listeners.selected(a,i),p.listeners.multiselected([a])}}});var D=A;h(c,D,p.config),i(c,D,this.config.renderingOptions.animation&&j,p.config),k(c,D,p.config),a.updateClipPaths(t,this.$bodySVG,"B",!0);var E=p.getClipSource.apply(this.$container[0][0]);e(t,D,o,p.config,E),f(t,D,o,p.config),p.config.renderingOptions.values?(A.classed("values",!0),A.each(function(a){var c=b.select(this);n(c,l(a),"valueonly","B",E)})):A.classed("values",!1).selectAll("text.valueonly").remove(),A.classed("selected",function(a){return p.storage.isSelected(a)})}}}(d||(d={}),b,a);var d;return function(a,b,c,d){a.prototype=a.prototype||{},a.prototype.layoutHeaders=function(c){var d=0,e=this.config,f=e.htmlLayout.headerHeight,g=e.htmlLayout.headerOffset;c.forEach(function(a){a.offsetX=d,a.offsetY=g,a.height=f-2*g,d+=a.getColumnWidth()});var h=d+4;b.values(e.svgLayout.plusSigns).forEach(function(a){a.x=h,h+=a.w+4}),c.filter(function(b){return b instanceof a.LayoutStackedColumn}).forEach(function(a){a.height=f/2-2*g;var b=0,c=a.offsetX,d=a.children.concat(a.emptyColumns);d.map(function(a){a.offsetX=c+b,a.localOffsetX=b,b+=a.getColumnWidth(),a.offsetY=f/2+g,a.height=f/2-2*g})}),this.totalWidth=h},a.prototype.updateHeader=function(d){if(!Array.isArray(d)||0!==d.length){d=d||this.storage.getColumnLayout();var e=this.$header,f=e.select("g.main"),g=this,h=this.config;this.headerUpdateRequired&&(this.layoutHeaders(d),this.$headerSVG.attr("width",this.totalWidth),this.$bodySVG.attr("width",this.totalWidth),this.headerUpdateRequired=!1);var i=[];d.forEach(function(a){a.flattenMe(i,{addEmptyColumns:!0})}),i.reverse(),a.updateClipPaths(i,this.$headerSVG,"H",!1,"columnheader");var j=f.selectAll(".header").data(i,function(a){return a.id});j.exit().remove();var k=j.enter().append("g").attr("class","header").classed("emptyHeader",function(b){return b instanceof a.LayoutEmptyColumn||b instanceof a.LayoutActionColumn}).classed("nestedHeader",function(b){return b&&b.parent instanceof a.LayoutStackedColumn}).call(function(){g.addResortDragging(this,h)});j.attr("transform",function(a){return"translate("+a.offsetX+","+a.offsetY+")"}),k.append("rect").attr({"class":"labelBG",y:0}).style("fill",function(b){return b instanceof a.LayoutEmptyColumn?"lightgray":b.column&&h.colorMapping.has(b.column.id)?h.colorMapping.get(b.column.id):h.grayColor}).on("click",function(c){if(!(b.event.defaultPrevented||c instanceof a.LayoutEmptyColumn||c instanceof a.LayoutActionColumn||c instanceof a.LayoutRankColumn||c instanceof a.LayoutStackedColumn&&c.children.length<1)){var d=h.columnBundles[c.columnBundle];null!==d.sortedColumn&&c===d.sortedColumn?d.sortingOrderAsc=!d.sortingOrderAsc:d.sortingOrderAsc=c instanceof a.LayoutStringColumn||c instanceof a.LayoutCategoricalColumn||c instanceof a.LayoutRankColumn,d.sortedColumn=c,g.listeners["change-sortcriteria"](this,c,d.sortingOrderAsc),g.config.sorting&&g.config.sorting.external||g.storage.resortData({column:c,asc:d.sortingOrderAsc}),g.updateAll(!1)}}),j.select(".labelBG").attr({width:function(a){return Math.max(a.getColumnWidth()-5,0)},height:function(a){return a.height}}),k.append("g").attr("class","hist");var l=j.filter(function(b){return b instanceof a.LayoutNumberColumn});this.config.renderingOptions.histograms?l.selectAll("g.hist").each(function(a){var c=b.select(this).attr("transform","scale(1,"+a.height+")");a.getHist(function(b){if(b){var d=a.value2pixel.copy().range([0,a.value2pixel.range()[1]-5]),e=c.selectAll("rect").data(b);e.enter().append("rect"),e.attr({x:function(a){return d(a.x)},width:function(a){return d(a.dx)},y:function(a){return 1-a.y},height:function(a){return a.y}})}})}):l.selectAll("g.hist").selectAll("*").remove(),this.config.manipulative&&(k.filter(function(b){return!(b instanceof a.LayoutEmptyColumn||b instanceof a.LayoutActionColumn)}).append("rect").attr({"class":"weightHandle",x:function(a){return Math.max(a.getColumnWidth()-5,0)},y:0,width:5}),j.select(".weightHandle").attr({x:function(a){return Math.max(a.getColumnWidth()-5,0)},height:function(a){return a.height}}).call(this.dragWeight)),k.append("text").attr({"class":"headerLabel",x:h.htmlLayout.labelLeftPadding}),k.append("title");var m=g.getClipSource.apply(this.$container[0][0]);if(j.select(".headerLabel").classed("sortedColumn",function(a){var b=h.columnBundles[a.columnBundle].sortedColumn;return b===a}).attr({y:function(b){return b instanceof a.LayoutStackedColumn||null!=b.parent?b.height/2:3*b.height/4},"clip-path":function(a){return"url("+m+"#clip-H"+a.id+")"}}).text(function(a){return a.getLabel()}),j.select("title").text(function(a){return a.getLabel()}),k.append("text").attr({"class":"headerSort",y:function(a){return a.height/2},x:2}),j.select(".headerSort").text(function(a){var b=h.columnBundles[a.columnBundle].sortedColumn;return b===a?h.columnBundles[a.columnBundle].sortingOrderAsc?"":"":""}).attr({y:function(a){return a.height/2}}),this.config.manipulative){var n=[{"class":"stackedColumnInfo",text:"",filter:function(b){return b instanceof a.LayoutStackedColumn?[b]:[]},action:function(a){g.stackedColumnOptionsGui(a)}},{"class":"singleColumnDelete",text:"",filter:function(b){return b instanceof a.LayoutRankColumn||b instanceof a.LayoutStackedColumn||b instanceof a.LayoutEmptyColumn||b instanceof a.LayoutActionColumn?[]:[b]},action:function(a){g.storage.removeColumn(a),g.listeners["columns-changed"](g),g.headerUpdateRequired=!0,g.updateAll()}},{"class":"singleColumnFilter",text:"",filter:function(a){return a.column?[a]:[]},offset:h.htmlLayout.buttonWidth,action:function(c){c instanceof a.LayoutStringColumn?g.openFilterPopup(c,b.select(this)):c instanceof a.LayoutCategoricalColumn?g.openCategoricalFilterPopup(c,b.select(this)):c instanceof a.LayoutNumberColumn&&g.openMappingEditor(c,b.select(this))}}];n.forEach(function(a){var b=j.selectAll("."+a["class"]).data(a.filter);b.exit().remove(),b.enter().append("text").attr("class","fontawe "+a["class"]).text(a.text).on("click",a.action),b.attr({x:function(b){return b.getColumnWidth()-h.htmlLayout.buttonRightPadding-(a.offset||0)},y:h.htmlLayout.buttonTopPadding})})}var o=b.values(h.svgLayout.plusSigns),p=f.selectAll(".addColumnButton").data(o);p.exit().remove();var q=p.enter().append("g").attr({"class":"addColumnButton"});p.attr({transform:function(a){return"translate("+a.x+","+a.y+")"}}),q.append("title").text(function(a){return a.title}),q.filter(function(a){return!a.render}).append("rect").attr({x:0,y:0,rx:5,ry:5,width:function(a){return a.w},height:function(a){return a.h}}).on("click",function(a){c.isFunction(a.action)?a.action.call(g,a):g[a.action](a)}),q.filter(function(a){return!a.render}).append("text").attr({x:function(a){return a.w/2},y:function(a){return a.h/2}}).text(function(a){return a.text||""}),q.filter(function(a){return!!a.render}).append(function(a){return a.render.call(g,a)}).on("click",function(a){c.isFunction(a.action)?a.action.call(g,a):g[a.action](a)})}},a.prototype.hoverHistogramBin=function(c){if(this.config.renderingOptions.histograms){var d=this.$header.selectAll("g.hist");d.selectAll("rect").classed("hover",!1),c&&this.$header.selectAll("g.hist").each(function(d){if(d instanceof a.LayoutNumberColumn){var e=this;d.getHist(function(a){a&&d.binOf(c,function(a){a>=0&&b.select(e).select("rect:nth-child("+(a+1)+")").classed("hover",!0)})})}})}},a.prototype.addResortDragging=function(c){function d(c){c instanceof a.LayoutEmptyColumn||(b.event.sourceEvent.stopPropagation(),b.select(this).classed("dragObject",!0),k=null,l=!1)}function e(c){function d(a,b,c){return b>a.offsetX&&b-a.offsetX<a.getColumnWidth()&&c>a.offsetY&&c-a.offsetY<a.height?b-a.offsetX<a.getColumnWidth()/2?{column:a,insert:"l",tickX:a.offsetX,tickY:a.offsetY,tickH:a.height}:{column:a,insert:"r",tickX:a.offsetX+a.getColumnWidth(),tickY:a.offsetY,tickH:a.height}:null}if(!(c instanceof a.LayoutEmptyColumn)){l=!0;var e=j.selectAll(".dragHeader").data([c]),f=e.enter().append("g").attr({"class":"dragHeader"});f.append("rect").attr({"class":"labelBG",width:function(a){return a.getColumnWidth()},height:function(a){return a.height}});var g=b.event.x,i=b.event.y;e.attr("transform",function(){return"translate("+(b.event.x+3)+","+(b.event.y-10)+")"});var m=[];h.storage.getColumnLayout().forEach(function(a){a.flattenMe(m,{addEmptyColumns:!0})});var n=0;for(k=null;n<m.length&&null==k;)k=d(m[n],g,i),n++;var o=j.selectAll(".columnTick").data(k?[k]:[]);o.exit().remove(),o.enter().append("rect").attr({"class":"columnTick",width:10}),o.attr({x:function(a){return a.tickX-5},y:function(a){return a.tickY},height:function(a){return a.tickH}})}}function f(c){b.event.defaultPrevented||c instanceof a.LayoutEmptyColumn||(b.select(this).classed("dragObject",!1),j.selectAll(".dragHeader").remove(),j.selectAll(".columnTick").remove(),k&&k.column===this.__data__||(k&&(b.event.sourceEvent.altKey?h.storage.copyColumn(this.__data__,k.column,k.insert):h.storage.moveColumn(this.__data__,k.column,k.insert),h.listeners["columns-changed"](h),h.headerUpdateRequired=!0,h.updateAll()),null==k&&l&&(h.headerUpdateRequired=!0,h.storage.removeColumn(this.__data__),h.listeners["columns-changed"](h),h.updateAll())))}if(this.config.manipulative){var g=b.behavior.drag(),h=this,i=this.$header,j=i.select("g.overlay"),k=null,l=!1;g.call(c),g.on("dragstart",d).on("drag",e).on("dragend",f)}},a.prototype.addNewEmptyStackedColumn=function(){this.storage.addStackedColumn(null,-1),this.headerUpdateRequired=!0,this.listeners["columns-changed"](this),this.updateAll()},a.prototype.clearSelection=function(){this.select()},a.prototype.getClipSource=function(){return this.ownerDocument&&this.ownerDocument.documentURI!==this.ownerDocument.baseURI?this.ownerDocument.documentURI:""},a.prototype.reweightHeader=function(a){a.column.setColumnWidth(a.value),this.headerUpdateRequired=!0,this.updateAll()}}(d||(d={}),b,a),d}"function"==typeof define&&define.amd?define(["jquery","d3","underscore"],a):"object"==typeof module&&module.exports?module.exports=a(require("jquery"),require("d3"),require("underscore")):this.LineUp=a(jQuery,d3,_)}).call(this);